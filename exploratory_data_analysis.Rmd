---
title: ""
author: ""
date: ""
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: hide
---

```{r, include=FALSE}

# Set global knit options

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = TRUE 
)

# Load libraries

library(tidyverse)
library(rvest)
library(readxl)
library(plotly)
library(flexdashboard)
library(sf)
library(shiny)
library(leaflet)
library(scales)
library(patchwork)
library(ggplot2)

```

# Exploratory Data Analysis

## ED Visits and Hospitalizations between 2016-2018 and 2019-2021

```{r}

# Load ED data for 2016-2018

ed_2016_2018 = 
  read_csv("data/ed_2016_2018.csv")

# Load ED data for 2019-2021

ed_2019_2021 = 
  read_csv("data/ed_2019_2021.csv")

# Load NYC zipcode shapefile

nyc_zip_sf <- st_read("shapefiles/geo_export_8df5c38c-c74c-4840-9d00-da16c0201e07.shp", quiet = TRUE)

# Combine datasets

all_data <- bind_rows(
  ed_2016_2018 %>% mutate(period = "2016-2018"),
  ed_2019_2021 %>% mutate(period = "2019-2021")
)

# Create borough averages for both indicators

borough_data <- all_data %>%
  group_by(borough, period, indicator) %>%
  summarize(avg_rate = mean(zip_code_rate, na.rm = TRUE))

# Create the map_data

borough_data <- borough_data %>%
  rename(boro_name = borough)

map_data <- nyc_zip_sf %>%
  left_join(borough_data, by = "boro_name")

```

### Emergency Department Visit Rates per 10,000 children (Aged 0-17 Years)

```{r, echo=FALSE}

# Create simple borough-level summaries

borough_summary <- all_data %>%
  group_by(borough, period, indicator) %>%
  summarize(
    avg_rate = round(mean(zip_code_rate, na.rm = TRUE), 1),
    .groups = "drop"  # This explicitly drops the grouping
  )

# Table for ED visits 

ed_summary <- borough_summary %>%
  filter(indicator == "ed_visits_rate") %>%
  pivot_wider(
    names_from = period,
    values_from = avg_rate
  ) %>%
  mutate(
    percent_change = round(((`2019-2021` - `2016-2018`) / `2016-2018` * 100), 1)
  ) %>%
  arrange(desc(`2016-2018`))

# Print ED Visits Summary

ed_summary %>%
  select(-indicator) %>%
  knitr::kable(
    col.names = c("Borough", "2016-2018", "2019-2021", "% Change")
  )

```

For ED visits, the Bronx had notably higher rates than other boroughs in both periods, with 347.7 and 180.7 per 10,000 children, respectively. All boroughs experienced substantial decreases between 2016-2018 and 2019-2021, ranging from about 43% to 48%. Despite these decreases, the Bronx's 2019-2021 rate of 180.7 remained higher than any other borough's rates from 2016-2018.


```{r}

# Create ED Visits Map 

ed_plot <- ggplot() +
  geom_sf(data = filter(map_data, indicator == "ed_visits_rate"), 
          aes(fill = avg_rate)) +
  facet_wrap(~period) +
  scale_fill_viridis_c(
    name = "Borough Average of\nED Visit Rates\nper 10,000 Children\nAged 0-17 Years", 
    option = "plasma"
  ) +
  theme_minimal() +
  labs(title = "Asthma ED Visit Rates by NYC Borough",
       subtitle = "Children aged 0-17 years") +
  theme(
    plot.title = element_text(size = 12),
    legend.position = "right",
    legend.key.height = unit(2, "cm"),
    axis.text = element_blank(),      
    axis.ticks = element_blank(),     
    panel.grid = element_blank()      
  )

# Display plot

ed_plot

```

Looking at the ED visit rates map across the two time periods (2016-2018 and 2019-2021), we can observe several key patterns:

* There appears to be a general decrease in ED visit rates from 2016-2018 to 2019-2021 across most NYC boroughs, as indicated by the darker purple colors in the later period.
* The Bronx (the northernmost borough) shows notably higher ED visit rates than other boroughs in both time periods, with rates exceeding 300 per 10,000 children aged 0-17 years in 2016-2018.
* Manhattan and Brooklyn by comparison appear to have moderate rates, while Staten Island (the southernmost borough) consistently shows lower ED visit rates in both periods.

The most striking change between the two periods is the apparent reduction in ED visits during 2019-2021, which could potentially be related to the COVID-19 pandemic's impact on healthcare utilization patterns.

### Asthma hospitalization rate per 10,000 children (aged 0-17 years)

```{r, echo=FALSE}

# Table for asthma hospitalizations

hosp_summary <- borough_summary %>%
  filter(indicator == "hosp_rate") %>%
  pivot_wider(
    names_from = period,
    values_from = avg_rate
  ) %>%
  mutate(
    percent_change = round(((`2019-2021` - `2016-2018`) / `2016-2018` * 100), 1)
  ) %>%
  arrange(desc(`2016-2018`))

# Print Hospitalization Summary

hosp_summary %>%
  select(-indicator) %>%
  knitr::kable(
    col.names = c("Borough", "2016-2018", "2019-2021", "% Change")
  )

```

For hospitalizations, a similar pattern emerged compared to ED visit rates, with the Bronx having the highest rates at 58.5 and 36.8 per 10,000 children in the two periods. All boroughs showed considerable decreases between 2016-2018 and 2019-2021, ranging from approximately 32% to 40%. Queens and Staten Island consistently had the lowest hospitalization rates in both periods.

```{r}

# Create Hospitalizations Map 

hosp_plot <- ggplot() +
  geom_sf(data = filter(map_data, indicator == "hosp_rate"), 
          aes(fill = avg_rate)) +
  facet_wrap(~period) +
  scale_fill_viridis_c(
    name = "Borough Average of\nHospitalization Rates\nper 10,000 Children\nAged 0-17 Years", 
    option = "plasma"
  ) +
  theme_minimal() +
  labs(title = "Asthma Hospitalization Rates by NYC Borough",
       subtitle = "Children aged 0-17 years") +
  theme(
    plot.title = element_text(size = 12),
    panel.grid = element_blank(),         
    axis.text = element_blank(),           
    axis.ticks = element_blank(),         
    axis.title = element_blank()         
  )

# Display plot

hosp_plot

```

Considering hospitalization rates across the two time periods (2016-2018 and 2019-2021), there are notable patterns:

* Similar to ED visits, there appears to be a general decrease in hospitalization rates from 2016-2018 to 2019-2021 across NYC boroughs, as shown by the darker purple colors in the later period.
* The Bronx again shows notably higher hospitalization rates compared to other boroughs in both periods, reaching over 50 per 10,000 children aged 0-17 years in 2016-2018.
* Geographic disparities persist in both periods, with Staten Island consistently showing lower hospitalization rates.
* When compared to the ED visit rates, the hospitalization rates are notably lower (scale of 0-50 versus 0-300), suggesting that while many children visit the ED for asthma, a smaller proportion require hospitalization.

Overall, the consistent geographic disparities in ED visits and hospitalizations, particularly the higher rates in the Bronx, confirm the unequal distribution of child asthma burden across New York City. This suggests underlying socioeconomic and/or environmental factors affecting childhood asthma rates across different parts of the city.

## Fine Particulate Matter (PM2.5) 

```{r}

# Load PM data

particulate_matter = 
  read_csv("data/Air_Quality_20231208.csv")

# Produce tidied PM dataset for analysis

tidy_analysis_pm = 
  particulate_matter |>
  janitor::clean_names() |>
    mutate(
    unique_id = as.character(unique_id),
    indicator_id = as.character(indicator_id),
    geo_join_id = as.character(geo_join_id)) |>
  filter(name == "Fine particles (PM 2.5)") |>
  filter(time_period %in% c("Annual Average 2016", "Annual Average 2017",
                            "Annual Average 2018", "Annual Average 2019",
                            "Annual Average 2020", "Annual Average 2021")) |>
  filter(geo_type_name == "Borough") |>
  select(-unique_id, -indicator_id, -start_date) |>
    rename(borough = geo_place_name) |>
  mutate(
    period = case_when(
      time_period %in% c("Annual Average 2016", "Annual Average 2017", "Annual Average 2018") ~ "2016-2018",
      time_period %in% c("Annual Average 2019", "Annual Average 2020", "Annual Average 2021") ~ "2019-2021"
    )
  ) |>
  group_by(borough, period) |>
  summarize(
    average_pm2.5 = mean(data_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_wider(
    names_from = period,
    values_from = average_pm2.5,
    names_prefix = "avg_pm2.5_"
  )

```

### Average PM2.5 Levels (μg/m³) Between 2016-2018 and 2019-2021

```{r}

# Plot of average PM2.5 levels by borough between 2016-2018 and 2019-2021

tidy_analysis_pm |>
  pivot_longer(cols = -borough, names_to = "Year_Group", values_to = "PM2.5") |> 
  mutate(borough = factor(borough, levels = unique(borough[order(PM2.5)]))) |> 
  ggplot(aes(x = borough, y = PM2.5, fill = Year_Group)) +
  geom_bar(position = "dodge", stat = "identity") +
   labs(
    title = "Average PM2.5 Levels by Borough (2016-2018 vs 2019-2021)",
    x = "Borough",
    y = "PM2.5 Values",
    fill = "Year Group"
  ) 

```

```{r}

# Print PM2.5 Summary

tidy_analysis_pm_diff <- 
  tidy_analysis_pm |>
  mutate(pm2.5_difference = `avg_pm2.5_2016-2018` - `avg_pm2.5_2019-2021`)

knitr::kable(tidy_analysis_pm_diff, col.names = c("borough", "avg_pm2.5_2016-2018", "avg_pm2.5_2019-2021", "pm2.5_difference"))

```

PM2.5 levels demonstrated consistent declines across all NYC boroughs between 2016-2018 and 2019-2021, as shown in both the bar plot and supporting data table. Manhattan maintained the highest concentrations in both periods (8.72 and 7.63 μg/m³ respectively), which is notably higher than other boroughs as evident by the tallest bars in the graph. The magnitude of improvement was remarkably uniform in the Bronx and Brooklyn, with the table showing identical reductions of 1.02 μg/m³ for both boroughs, while Queens experienced the smallest decrease at 0.72 μg/m³. Staten Island consistently maintained the lowest PM2.5 levels among all boroughs, with averages dropping from 6.68 to 5.87 μg/m³, as evidenced by the shortest bars in the plot.

### PM2.5 Levels by United Hospital Fund (UHF42) Neighborhoods, 2016-2018 vs. 2019-2021

```{r}

# Load NYC geospatial data

geography = 
  read_excel("data/geoid_borough_name_nyc.xlsx") |>
  rename(geo_join_id = ID) |>
  mutate(geo_join_id = 
           as.character(geo_join_id))

# Tidy dataset for geospatial PM analysis

tidy_uhf42_pm = 
  particulate_matter |>
  janitor::clean_names() |>
    mutate(
    unique_id = as.character(unique_id),
    indicator_id = as.character(indicator_id),
    geo_join_id = as.character(geo_join_id)) |>
  filter(name == "Fine particles (PM 2.5)") |>
  filter(time_period %in% c("Annual Average 2016", "Annual Average 2017",
                            "Annual Average 2018", "Annual Average 2019",
                            "Annual Average 2020", "Annual Average 2021")) |>
  filter(geo_type_name == "UHF42") |>
  select(-unique_id, -indicator_id, -start_date) |>
  mutate(
    period = case_when(
      time_period %in% c("Annual Average 2016", "Annual Average 2017", "Annual Average 2018") ~ "2016_2018",
      time_period %in% c("Annual Average 2019", "Annual Average 2020", "Annual Average 2021") ~ "2019_2021"
    )
  ) |>
  group_by(geo_place_name, geo_join_id, period) |>
  summarize(
    average_pm2.5 = mean(data_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_wider(
    names_from = period,
    values_from = average_pm2.5,
    names_prefix = "avg_pm2.5_"
  ) 

# Load shapefiles map for UHF data

uhf42_map <- st_read("data/UHF_42_DOHMH_2009.shp", quiet = TRUE) 

tidy_uhf42_pm <- 
  tidy_uhf42_pm |>
  rename(UHFCODE = geo_join_id) |>
  mutate(
    UHFCODE = as.double(UHFCODE))

# Combine geospatial data and PM data

map_uhf42 <- 
  uhf42_map |>
  left_join(tidy_uhf42_pm, by = "UHFCODE") |>
  pivot_longer(cols = starts_with("avg_pm2.5_"), 
               names_to = "time_period", 
               values_to = "avg_pm2.5")

# Produce heat map 

heat_map_pm2.5 <- ggplot() +
  geom_sf(data = map_uhf42, aes(fill = avg_pm2.5)) +
  facet_wrap(~time_period, ncol = 2) +
  scale_fill_viridis_c(option = "plasma", na.value = "grey50") +
  labs(
    title = "PM2.5 (ug/m3) Levels by UHF42 Neighborhood",
    fill = "PM2.5"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),
    legend.position = "right",
    legend.key.height = unit(2, "cm")
  )

# Show heat map for PM2.5 

heat_map_pm2.5

```

Looking at the PM2.5 levels across the two time periods (2016-2018 and 2019-2021), we can observe a general decrease in PM2.5 concentrations across the majority of UHF42 neighborhoods, as shown by the more prevalent darker purple coloring in the 2019-2021 map indicating lower levels. Midtown Manhattan shows consistently high PM2.5 levels across both time periods, appearing as yellow and orange areas on the maps, while Staten Island maintains the lowest PM2.5 levels across all boroughs, shown by consistent dark purple coloring. 

The marked improvement in air quality from 2016-2018 to 2019-2021 likely reflects the impact of the COVID-19 pandemic, which resulted in significantly reduced traffic and industrial pollution during this period.

## Greenspace

```{r greenspace clean, include=FALSE}
greenspace_clean = read_csv("./data/Parks_Properties_20241126.csv", na = c("NA", ".", "")) |>
  janitor::clean_names() |> 
  mutate(
    borough = case_match(borough, #renamed borough according to data dictionary
      "R" ~ "Staten Island",
      "Q" ~ "Queens",
      "X" ~ "Bronx",
      "B" ~ "Brooklyn",
      "M" ~ "Manhattan"),
    typecategory = as.factor(typecategory), #converted char variables into factors
    borough = as.factor(borough)) |>
  separate(acquisitiondate, into = c("year", "month", "day"), sep = "-") |>
  select(year, borough, acres, typecategory) |> 
  filter(year < 2022 | is.na(year))
```



#### Borough and Year Comparison

```{r first year, include=FALSE}
#2016-2018 dataset
dataset1_gs = greenspace_clean |>
  filter(year < 2019 | is.na(year)) |> 
  group_by(year, borough) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

dataset1_gs_calc = dataset1_gs |> 
  group_by(borough) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "2016-2018")
```

```{r second year, include=FALSE}
#2019-2021 dataset
dataset2_gs = greenspace_clean |>
  filter(year < 2022 | is.na(year)) |>
  group_by(year, borough) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

dataset2_gs_calc = dataset2_gs |> 
  group_by(borough) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "2019-2021")
```

```{r total acres dataset, echo=FALSE}
total_acres = bind_rows(dataset1_gs_calc, dataset2_gs_calc)
  
#total acres dataset
Greenspace_data = total_acres |>
  pivot_wider(names_from = year_group,
              values_from = acres_sum)
```

```{r, echo=FALSE}
ggplot(total_acres, aes(x = reorder(borough, acres_sum), y = acres_sum, fill = year_group)) + 
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) + 
  labs(x = "Borough", y = "Greenspace (Total Acres)", title = "Greenspaces Across Borough by Year Group") +
  theme_minimal()
```

Bronx had the least amount of greenspace, followed by Manhattan, Brooklyn, and Queens. Staten Island had the highest amount of greenspace. This trend is similar between both year groups.

#### Greenspace increase

Comparing between the two year groups, Staten Island had the largest increase (258.720 acres) in greenspaces and Manhattan had the least (0.345 acres).

```{r Total acres table, echo=FALSE}

Greenspace_data |>
  mutate(
    Difference = round(`2019-2021` - `2016-2018`, 3)) |>
  arrange(desc(Difference)) |>
  knitr::kable()
```

#### Greenspace Types

```{r, include=FALSE}
types_nyc = greenspace_clean |>
  select(-borough) |>
  group_by(typecategory) |>
  summarise(acres_tp = mean(acres, na.rm = TRUE), .groups = "drop")
```

```{r, include=FALSE}
type1A = greenspace_clean |>
  filter(year < 2019 | is.na(year)) |> 
  group_by(year, borough, typecategory) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

type1B = type1A |> 
  group_by(borough, typecategory) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "year1") #2016-2018
```

```{r, include=FALSE}
type2A = greenspace_clean |>
  filter(year < 2022 | is.na(year)) |>
  group_by(year, borough, typecategory) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

type2B = type2A |> 
  group_by(borough, typecategory) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "year2") #2019-2021
```

```{r binded, include=FALSE}

binded = bind_rows(type1B, type2B) |>
  group_by(typecategory, year_group) |>
  summarise(acres_total = sum(acres_sum, na.rm = TRUE))
```


```{r, echo=FALSE}

binded |> 
   mutate(year_group = case_match(year_group,
      "year1" ~ "2016-2018",
      "year2" ~ "2019-2021")) |>
  ggplot(aes(x = reorder(typecategory, acres_total), y = acres_total, fill = year_group)) + 
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(x = "Greenspace Types", y = "Total Acres", title = "Total Acres of NYC Greenspace by Type and Year Group") +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

In terms of total acres, flagship parks make up the largest proportion of NYC greenspace. This trend is similar for both year groups.

```{r, echo=FALSE}

#increase in acres by type

Total_acres_table_test = binded |>
  pivot_wider(names_from = year_group,
              values_from = acres_total) |>
  mutate(diff = round(year2 - year1, 3))

table_type = Total_acres_table_test |>
  filter(diff > 0) |>
  arrange(desc(diff))

knitr::kable(table_type, col.names = c("Greenspace Type", "2016-2018", "2019-2021", "Difference"))

```

7 of the 21 greenspace types had an increase in total acres between the two year groups. No change was seen in the remaining greenspace types. 

**Top 3 Greenspace Types (Total Acres) Across Boroughs**

```{r, echo=FALSE, message = FALSE}

perBor = bind_rows(type1B, type2B) |>
  group_by(typecategory, year_group, borough) |>
  summarise(acres_total = sum(acres_sum, na.rm = TRUE)) 

Bronx_perBor = perBor |> 
  filter(borough == "Bronx") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 200) #keep top 3

Brook_perBor = perBor |> 
  filter(borough == "Brooklyn") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 500) #keep top 3

Man_perBor = perBor |> 
  filter(borough == "Manhattan") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 200) #keep top 3

Q_perBor = perBor |> 
  filter(borough == "Queens") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 900) #keep top 3

SI_perBor = perBor |> 
  filter(borough == "Staten Island") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 760) #keep top 3

#bind them together
top3_bor_gstype = bind_rows(Bronx_perBor, Brook_perBor, Q_perBor, Man_perBor, SI_perBor) |>
  select(borough, typecategory, year1, year2) |>
#Since total acres didn't change for the top 3 categories for each borough between the years, update year variable.
  rename(acres = year1) |>
  select(-year2) |>
  group_by(borough) |>
  mutate(rank = rank(-acres)) |>
  ungroup() |>
  mutate(
    rank = case_match(rank,
      1 ~ "First",
      2 ~ "Second",
      3 ~ "Third"),
    typecategory = paste(typecategory, " (", acres, ")", sep = "")) |>
    select(-acres) |>
  pivot_wider(
    names_from = rank,
    values_from = typecategory) 

knitr::kable(top3_bor_gstype, col.names = c("Borough", "Highest", "Second Highest", "Third Highest"))
 
```

The total acres of each greenspace type for each borough is the same for both year group. 

Top categories of greenspace types across the boroughs include Flagship Park, Community Park, Nature Area, Parkway, Waterfront Facility, and Neighborhood Park. We also see that the top 3 greenspace types are different for each borough.


## Temperature

```{r}
# Load raw temperature data for each borough

manhattan = read_csv("data/manhattan.csv",skip = 3) |>
  mutate(Borough = "Manhattan") |> 
  janitor::clean_names()

bronx = read_csv("data/bronx.csv",skip = 3) |>
  mutate(Borough = "Bronx") |> 
  janitor::clean_names()

brooklyn = read_csv("data/brooklyn.csv",skip = 3) |>
  mutate(Borough = "Brooklyn") |> 
  janitor::clean_names()

queens = read_csv("data/queens.csv",skip = 3) |>
  mutate(Borough = "Queens") |> 
  janitor::clean_names()

staten_island = read_csv("data/staten_island.csv",skip = 3) |>
  mutate(Borough = "Staten Island") |> 
  janitor::clean_names()

```

```{r}
all_temp = bind_rows(manhattan, bronx, brooklyn, queens, staten_island) |> 
  mutate(borough = as.factor(borough)) |> 
  mutate(date = as.Date(time, format = "%d/%m/%Y")) |> 
  select(time:temperature_2m_mean, borough, date) |> 
  mutate(years = year(date)) |> 
  mutate(months = as.Date(paste0(format(date, "%Y-%m"), "-01"), format = "%Y-%m-%d"))

all_temp_borough = all_temp |> 
  mutate(date = as.Date(time, format = "%d/%m/%Y")) |>  # Corrected date format
  mutate(data_years = ifelse(year(date) %in% 2016:2018, "2016-2018", "2019-2021")) |> 
  select(temperature_2m_max:data_years) |> 
  group_by(data_years, borough) |> 
  summarise(avg_temperature = mean(temperature_2m_mean, na.rm = TRUE))

```


#### Monthly Mean temperature by borough

This graph shows the monthly mean temperature change by Borough between 2016 and 2021.

```{r}

# Monthly Mean temperature

all_temp_month = all_temp |> 
  group_by(months, borough) |> 
  summarise(avg_month = mean(temperature_2m_mean, na.rm = TRUE))

ggplot(all_temp_month, aes(x = months, y = avg_month, color = borough)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Monthly Mean Temperature (2016-2021) by Borough",
    x = "Month",
    y = "Average Temperature (°C)",
    color = "Borough"
  ) +
  theme_minimal()
```

#### Max, Min, Mean temperature trend by year and borough

This 5 plots shows the highest temperature mean, lowest temperature mean, and total mean temperature by year and borough.

```{r}
# Max, Min, Mean temperature trend by year and borough

mean_temp_year = all_temp |> 
  group_by(years, borough) |> 
  summarize(
    high_temp = mean(temperature_2m_max, na.rm = TRUE),
    low_temp = mean(temperature_2m_min, na.rm = TRUE),
    mean_temp = mean(temperature_2m_mean, na.rm = TRUE)
  ) |> 
  arrange(years, borough) 


long_data <- mean_temp_year |> 
  pivot_longer(
    cols = c(high_temp, low_temp, mean_temp),
    names_to = "Temperature_Type",            
    values_to = "Temperature"             
  )

ggplot(long_data, aes(x = years, y = Temperature, color = Temperature_Type, group = Temperature_Type)) +
  geom_line(size = 1) +                   
  geom_point(size = 2) +              
  labs(
    title = "Mean Temperature Trends by Year and Borough",
    x = "Year",
    y = "Temperature (°C)",       
    color = "Mean Temperature Type"
  ) +
    scale_color_manual(
    values = c("high_temp" = "red", "low_temp" = "blue", "mean_temp" = "darkgreen"), # Color mapping
    labels = c("high_temp" = "Highest Temperature", 
               "low_temp" = "Lowest Temperature", 
               "mean_temp" = "Mean Temperature")) +
  theme_minimal() +                    
  facet_wrap(~ borough)  
  
```

#### Average temperature change by borough

There has been mean temperature change between years but it is steady overall across the boroughs.


```{r}

#average temperature table

mean_temp_table = mean_temp_year |> 
  select(borough, years, mean_temp) |> 
  pivot_wider(
    names_from = borough,
    values_from = mean_temp
  )

knitr::kable(mean_temp_table)
```


#### Average temperature by year group and borough

In terms of analysis by the year group 2016-2018 and 2019-2021. There has been mean temperature increase among all boroughs. Manhattan and Bronx showed the biggest increase.

```{r}

ggplot(data = all_temp_borough, aes(x = data_years, y = avg_temperature, color = borough)) +
  geom_point(size = 3) +
  geom_line(aes(group = borough), size = 1) +
  labs(title = "Average Temperature by Date Group and Borough",
       x = "Date Group",
       y = "Average Temperature") +
  theme_minimal()

```


