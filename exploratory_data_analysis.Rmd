---
title: ""
author: ""
date: ""
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    code_folding: hide
---

```{r, include=FALSE}

# Set global knit options

knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = TRUE 
)

# Load libraries

library(tidyverse)
library(rvest)
library(readxl)
library(plotly)
library(flexdashboard)
library(sf)
library(shiny)
library(leaflet)
library(scales)
library(patchwork)
library(ggplot2)

```

# Exploratory Data Analysis

## Comparison of ED Admissions and Hospitalizations between 2016-2018 and 2019-2021

```{r}

# Load ED data for 2016-2018

ed_2016_2018 = 
  read_csv("data/ed_2016_2018.csv")

# Load ED data for 2019-2021

ed_2019_2021 = 
  read_csv("data/ed_2019_2021.csv")

# Load NYC zipcode shapefile

nyc_zip_sf <- st_read("shapefiles/geo_export_8df5c38c-c74c-4840-9d00-da16c0201e07.shp", quiet = TRUE)

# Combine datasets

all_data <- bind_rows(
  ed_2016_2018 %>% mutate(period = "2016-2018"),
  ed_2019_2021 %>% mutate(period = "2019-2021")
)

# Create borough averages for both indicators

borough_data <- all_data %>%
  group_by(borough, period, indicator) %>%
  summarize(avg_rate = mean(zip_code_rate, na.rm = TRUE))

# Create the map_data

borough_data <- borough_data %>%
  rename(boro_name = borough)

map_data <- nyc_zip_sf %>%
  left_join(borough_data, by = "boro_name")

```

### ED Admissions

```{r}

# Create ED Visits Map 

ed_plot <- ggplot() +
  geom_sf(data = filter(map_data, indicator == "ed_visits_rate"), 
          aes(fill = avg_rate)) +
  facet_wrap(~period) +
  scale_fill_viridis_c(
    name = "Borough Average of\nED Visit Rates\nper 10,000 Children\nAged 0-17 Years", 
    option = "plasma"
  ) +
  theme_minimal() +
  labs(title = "Asthma ED Visit Rates by NYC Borough",
       subtitle = "Children aged 0-17 years") +
  theme(
    plot.title = element_text(size = 12),
    legend.position = "right",
    legend.key.height = unit(2, "cm")
  )

# Display plot

ed_plot

```

Looking at the ED visit rates map across the two time periods (2016-2018 and 2019-2021), we can observe several key patterns:

* There appears to be a general decrease in ED visit rates from 2016-2018 to 2019-2021 across most NYC boroughs, as indicated by the darker purple colors in the later period.
* The Bronx (the northernmost borough) shows notably higher ED visit rates than other boroughs in both time periods, with rates exceeding 300 per 10,000 children aged 0-17 years in 2016-2018.
* Manhattan and Brooklyn by comparison appear to have moderate rates, while Staten Island (the southernmost borough) consistently shows lower ED visit rates in both periods.

The most striking change between the two periods is the apparent reduction in ED visits during 2019-2021, which could potentially be related to the COVID-19 pandemic's impact on healthcare utilization patterns.

### ED Hospitalizations

```{r}

# Create Hospitalizations Map 

hosp_plot <- ggplot() +
  geom_sf(data = filter(map_data, indicator == "hosp_rate"), 
          aes(fill = avg_rate)) +
  facet_wrap(~period) +
  scale_fill_viridis_c(
    name = "Borough Average of\nHospitalization Rates\nper 10,000 Children\nAged 0-17 Years", 
    option = "plasma"
  ) +
  theme_minimal() +
  labs(title = "Asthma Hospitalization Rates by NYC Borough",
       subtitle = "Children aged 0-17 years") +
  theme(plot.title = element_text(size = 12))

# Display plot

hosp_plot

```

Considering hospitalization rates across the two time periods (2016-2018 and 2019-2021), there are notable patterns:

* Similar to ED visits, there appears to be a general decrease in hospitalization rates from 2016-2018 to 2019-2021 across NYC boroughs, as shown by the darker purple colors in the later period.
* The Bronx again shows notably higher hospitalization rates compared to other boroughs in both periods, reaching over 50 per 10,000 children aged 0-17 years in 2016-2018.
* Geographic disparities persist in both periods, with Staten Island consistently showing lower hospitalization rates.
* When compared to the ED visit rates, the hospitalization rates are notably lower (scale of 0-50 versus 0-300), suggesting that while many children visit the ED for asthma, a smaller proportion require hospitalization.

Overall, the consistent geographic disparities in ED visits and hospitalizations, particularly the higher rates in the Bronx, confirm the unequal distribution of child asthma burden across New York City. This suggests underlying socioeconomic and/or environmental factors affecting childhood asthma rates across different parts of the city.

## PM2.5 

Plot comparisons by year/borough. 

```{r}
particulate_matter = 
  read_csv("data/Air_Quality_20231208.csv")

tidy_analysis_pm = 
  particulate_matter |>
  janitor::clean_names() |>
    mutate(
    unique_id = as.character(unique_id),
    indicator_id = as.character(indicator_id),
    geo_join_id = as.character(geo_join_id)) |>
  filter(name == "Fine particles (PM 2.5)") |>
  filter(time_period %in% c("Annual Average 2016", "Annual Average 2017",
                            "Annual Average 2018", "Annual Average 2019",
                            "Annual Average 2020", "Annual Average 2021")) |>
  filter(geo_type_name == "Borough") |>
  select(-unique_id, -indicator_id, -start_date) |>
    rename(borough = geo_place_name) |>
  mutate(
    period = case_when(
      time_period %in% c("Annual Average 2016", "Annual Average 2017", "Annual Average 2018") ~ "2016-2018",
      time_period %in% c("Annual Average 2019", "Annual Average 2020", "Annual Average 2021") ~ "2019-2021"
    )
  ) |>
  group_by(borough, period) |>
  summarize(
    average_pm2.5 = mean(data_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_wider(
    names_from = period,
    values_from = average_pm2.5,
    names_prefix = "avg_pm2.5_"
  )

```

```{r}
tidy_analysis_pm |>
  pivot_longer(cols = -borough, names_to = "Year_Group", values_to = "PM2.5") |> 
  mutate(borough = factor(borough, levels = unique(borough[order(PM2.5)]))) |> 
  ggplot(aes(x = borough, y = PM2.5, fill = Year_Group)) +
  geom_bar(position = "dodge", stat = "identity") +
   labs(
    title = "Average PM2.5 Levels by Borough (2016-2018 vs 2019-2021)",
    x = "Borough",
    y = "PM2.5 Values",
    fill = "Year Group"
  ) 
```

make knitr chart that shows with in numbers differences between years 

Show map of PM2.5 levels per UH42 index across years. 

```{r}
geography = 
  read_excel("data/geoid_borough_name_nyc.xlsx") |>
  rename(geo_join_id = ID) |>
  mutate(geo_join_id = 
           as.character(geo_join_id))
```

```{r}
particulate_matter = 
  read_csv("data/Air_Quality_20231208.csv")
```

```{r}
tidy_uhf42_pm = 
  particulate_matter |>
  janitor::clean_names() |>
    mutate(
    unique_id = as.character(unique_id),
    indicator_id = as.character(indicator_id),
    geo_join_id = as.character(geo_join_id)) |>
  filter(name == "Fine particles (PM 2.5)") |>
  filter(time_period %in% c("Annual Average 2016", "Annual Average 2017",
                            "Annual Average 2018", "Annual Average 2019",
                            "Annual Average 2020", "Annual Average 2021")) |>
  filter(geo_type_name == "UHF42") |>
  select(-unique_id, -indicator_id, -start_date) |>
  mutate(
    period = case_when(
      time_period %in% c("Annual Average 2016", "Annual Average 2017", "Annual Average 2018") ~ "2016_2018",
      time_period %in% c("Annual Average 2019", "Annual Average 2020", "Annual Average 2021") ~ "2019_2021"
    )
  ) |>
  group_by(geo_place_name, geo_join_id, period) |>
  summarize(
    average_pm2.5 = mean(data_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_wider(
    names_from = period,
    values_from = average_pm2.5,
    names_prefix = "avg_pm2.5_"
  ) 
```

```{r}
uhf42_map <- st_read("data/UHF_42_DOHMH_2009.shp", quiet = TRUE) 

tidy_uhf42_pm <- 
  tidy_uhf42_pm |>
  rename(UHFCODE = geo_join_id) |>
  mutate(
    UHFCODE = as.double(UHFCODE))
```


```{r}
map_uhf42 <- 
  uhf42_map |>
  left_join(tidy_uhf42_pm, by = "UHFCODE") 
```



## Greenspace


```{r greenspace clean, include=FALSE}
greenspace_clean = read_csv("./data/Parks_Properties_20241126.csv", na = c("NA", ".", "")) |>
  janitor::clean_names() |> 
  mutate(
    borough = case_match(borough, #renamed borough according to data dictionary
      "R" ~ "Staten Island",
      "Q" ~ "Queens",
      "X" ~ "Bronx",
      "B" ~ "Brooklyn",
      "M" ~ "Manhattan"),
    typecategory = as.factor(typecategory), #converted char variables into factors
    borough = as.factor(borough)) |>
  separate(acquisitiondate, into = c("year", "month", "day"), sep = "-") |>
  select(year, borough, acres, typecategory) |> 
  filter(year < 2022 | is.na(year))
```



#### Borough and Year Comparison

```{r first year, include=FALSE}
#2016-2018 dataset
dataset1_gs = greenspace_clean |>
  filter(year < 2019 | is.na(year)) |> 
  group_by(year, borough) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

dataset1_gs_calc = dataset1_gs |> 
  group_by(borough) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "2016-2018")
```

```{r second year, include=FALSE}
#2019-2021 dataset
dataset2_gs = greenspace_clean |>
  filter(year < 2022 | is.na(year)) |>
  group_by(year, borough) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

dataset2_gs_calc = dataset2_gs |> 
  group_by(borough) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "2019-2021")
```

```{r total acres dataset, echo=FALSE}
total_acres = bind_rows(dataset1_gs_calc, dataset2_gs_calc)
  
#total acres dataset
Greenspace_data = total_acres |>
  pivot_wider(names_from = year_group,
              values_from = acres_sum)
```

```{r, echo=FALSE}
ggplot(total_acres, aes(x = reorder(borough, acres_sum), y = acres_sum, fill = year_group)) + 
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) + 
  labs(x = "Borough", y = "Greenspace (Total Acres)", title = "Greenspaces Across Borough by Year Group") +
  theme_minimal()
```

Bronx had the least amount of greenspace, followed by Manhattan, Brooklyn, and Queens. Staten Island had the highest amount of greenspace. This trend is similar between both year groups.

#### Greenspace increase

Comparing between the two year groups, Staten Island had the largest increase (258.720 acres) in greenspaces and Manhattan had the least (0.345 acres).

```{r Total acres table, echo=FALSE}

Greenspace_data |>
  mutate(
    Difference = round(`2019-2021` - `2016-2018`, 3)) |>
  arrange(desc(Difference)) |>
  knitr::kable()
```

#### Greenspace Types

```{r, include=FALSE}
types_nyc = greenspace_clean |>
  select(-borough) |>
  group_by(typecategory) |>
  summarise(acres_tp = mean(acres, na.rm = TRUE), .groups = "drop")
```

```{r, include=FALSE}
type1A = greenspace_clean |>
  filter(year < 2019 | is.na(year)) |> 
  group_by(year, borough, typecategory) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

type1B = type1A |> 
  group_by(borough, typecategory) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "year1") #2016-2018
```

```{r, include=FALSE}
type2A = greenspace_clean |>
  filter(year < 2022 | is.na(year)) |>
  group_by(year, borough, typecategory) |>
  summarise(avg_acres_per_yr_bor = mean(acres, na.rm = TRUE), .groups = "drop")

type2B = type2A |> 
  group_by(borough, typecategory) |> 
  summarise(acres_sum = sum(avg_acres_per_yr_bor, na.rm = TRUE), .groups = "drop") |> 
  mutate(year_group = "year2") #2019-2021
```

```{r binded, include=FALSE}

binded = bind_rows(type1B, type2B) |>
  group_by(typecategory, year_group) |>
  summarise(acres_total = sum(acres_sum, na.rm = TRUE))
```


```{r, echo=FALSE}

binded |> 
   mutate(year_group = case_match(year_group,
      "year1" ~ "2016-2018",
      "year2" ~ "2019-2021")) |>
  ggplot(aes(x = reorder(typecategory, acres_total), y = acres_total, fill = year_group)) + 
  geom_bar(stat = "identity", position = "dodge", width = 0.6) +
  labs(x = "Greenspace Types", y = "Total Acres", title = "Total Acres of NYC Greenspace by Type and Year Group") +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

In terms of total acres, flagship parks make up the largest proportion of NYC greenspace. This trend is similar for both year groups.

```{r, echo=FALSE}

#increase in acres by type

Total_acres_table_test = binded |>
  pivot_wider(names_from = year_group,
              values_from = acres_total) |>
  mutate(diff = round(year2 - year1, 3))

table_type = Total_acres_table_test |>
  filter(diff > 0) |>
  arrange(desc(diff))

knitr::kable(table_type, col.names = c("Greenspace Type", "2016-2018", "2019-2021", "Difference"))

```

7 of the 21 greenspace types had an increase in total acres between the two year groups. No change was seen in the remaining greenspace types. 

**Top 3 Greenspace Types (Total Acres) Across Boroughs**

```{r, echo=FALSE, message = FALSE}

perBor = bind_rows(type1B, type2B) |>
  group_by(typecategory, year_group, borough) |>
  summarise(acres_total = sum(acres_sum, na.rm = TRUE)) 

Bronx_perBor = perBor |> 
  filter(borough == "Bronx") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 200) #keep top 3

Brook_perBor = perBor |> 
  filter(borough == "Brooklyn") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 500) #keep top 3

Man_perBor = perBor |> 
  filter(borough == "Manhattan") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 200) #keep top 3

Q_perBor = perBor |> 
  filter(borough == "Queens") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 900) #keep top 3

SI_perBor = perBor |> 
  filter(borough == "Staten Island") |>
  mutate(acres_total = round(acres_total, 2)) |>
  pivot_wider(
    names_from = year_group,
    values_from = acres_total) |>
  arrange(desc(year1)) |>
  filter(year1 > 760) #keep top 3

#bind them together
top3_bor_gstype = bind_rows(Bronx_perBor, Brook_perBor, Q_perBor, Man_perBor, SI_perBor) |>
  select(borough, typecategory, year1, year2) |>
#Since total acres didn't change for the top 3 categories for each borough between the years, update year variable.
  rename(acres = year1) |>
  select(-year2) |>
  group_by(borough) |>
  mutate(rank = rank(-acres)) |>
  ungroup() |>
  mutate(
    rank = case_match(rank,
      1 ~ "First",
      2 ~ "Second",
      3 ~ "Third"),
    typecategory = paste(typecategory, " (", acres, ")", sep = "")) |>
    select(-acres) |>
  pivot_wider(
    names_from = rank,
    values_from = typecategory) 

knitr::kable(top3_bor_gstype, col.names = c("Borough", "Highest", "Second Highest", "Third Highest"))
 
```

The total acres of each greenspace type for each borough is the same for both year group. 

Top categories of greenspace types across the boroughs include Flagship Park, Community Park, Nature Area, Parkway, Waterfront Facility, and Neighborhood Park. We also see that the top 3 greenspace types are different for each borough.


## Temperature


